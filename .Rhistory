ungroup()
units(d3$residence) <- "hours"
library(dplyr)
d3 <- d3 %>%
group_by(detyear, TagID) %>%
arrange(arrival) %>%
mutate(residence = departure - arrival) %>%
ungroup()
units(d3$residence) <- "hours"
head(d3)
dp <- d3 %>%
group_by(detyear, TagID) %>%
mutate(transit_time = difftime(lead(arrival), departure, units = "hours"))
load("data_tidy/fishpaths11-15.Rdata")
d3$residence <- d3$departure - d3$arrival
units(d3$residence) <- "days"
library(dplyr)
dp <- d3 %>%
filter(residence != 0) %>% # filter out single detections
group_by(detyear, TagID) %>%
arrange(arrival) %>%
mutate(transit_time = difftime(lead(arrival), departure, units = "hours")) %>%
ungroup()
range(dp$transit_time, na.rm = TRUE)
dp$transit_time <- as.numeric(dp$transit_time)
range(dp$transit_time, na.rm = TRUE)
load("data_tidy/fishpaths11-15.Rdata")
d3$residence <- d3$departure - d3$arrival
units(d3$residence) <- "days"
library(dplyr)
dp <- d3 %>%
filter(residence != 0) %>% # filter out single detections
group_by(detyear, TagID) %>%
arrange(arrival) %>%
mutate(transit_time = difftime(lead(arrival), departure, units = "hours")) %>%
ungroup()
range(dp$transit_time, na.rm = TRUE)
dp$transit_time <- as.numeric(dp$transit_time)
range(dp$transit_time, na.rm = TRUE)
dp <- dp %>%
group_by(detyear, TagID) %>%
arrange(arrival) %>%
filter(transit_time < 50*24, transit_time > 0) %>% # filters out transits greater than 50 days
mutate(move_num = cumsum(!duplicated(Station) | c(F, abs(diff(Rkm)) > 0.60))) %>% # skip the BC transits
ungroup() %>%
group_by(detyear, TagID, move_num) %>%
slice(length(move_num)) %>%
ungroup()
range(dp$transit_time) # good enough for first poster
dp2 <- dp %>%
group_by(detyear, TagID) %>%
arrange(move_num) %>%
mutate(diffRkm = abs(lead(Rkm) - Rkm),
rate = diffRkm/transit_time) %>%
ungroup %>%
filter(rate < 100)
range(dp2$rate, na.rm = TRUE)
dp2$detyear <- factor(dp2$detyear, labels = c(  "2011 - 2012",
"2012 - 2013",
"2013 - 2014",
"2014 - 2015",
"2015 - 2016"))
dp2 <- filter(dp2, detyear != "2011 - 2012")
detach("package:dplyr", unload=TRUE)
library(rethinking)
d1$dSp <- ifelse(d1$Sp == "chn", 1, 0)
d1 <- dp2
d1$dSp <- ifelse(d1$Sp == "chn", 1, 0)
d1 <- as.data.frame(d1)
head(d1)
chn_model <- map(flist = alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a + bSp*dSp,
a ~ runif(0, 20) ,
bSp ~ dnorm(0, 5),
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
range(d1$rate)
chn_model <- map(
alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a + bSp*dSp,
a ~ runif(0, 5) ,
bSp ~ dnorm(0, 1),
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
detach("package:rethinking", unload=TRUE)
detach("package:tidyverse", unload=TRUE)
library(rethinking)
d1 <- dp2
d1$dSp <- ifelse(d1$Sp == "chn", 1, 0)
d1 <- as.data.frame(d1)
head(d1)
range(d1$rate)
chn_model <- map(
alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a + bSp*dSp,
a ~ runif(0, 5) ,
bSp ~ dnorm(0, 1),
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
m1a <- map(flist = alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a + bSp*dSp,
a ~ dnorm(0, 10) ,
bSp ~ dnorm(0, 1),
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
precis(m1a) # shows an increase of 0.53km/hour for chinook than for white sturgeon.  But that's just in 2013, when there were many more chn than white sturgeon.
m1a <- map(flist = alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a,
a ~ dnorm(0, 10) ,
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
m1a <- map(flist = alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a + bSp*dSp,
a ~ dnorm(0, 10) ,
bSp ~ dnorm(0, 1),
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
precis(m1a) # shows an increase of 0.53km/hour for chinook than for white sturgeon.  But that's just in 2013, when there were many more chn than white sturgeon.
m1int <- map(flist = alist(
rate ~ dnorm(mean = mu, sd = sigma) ,
mu <- a,
a ~ dnorm(0, 10) ,
sigma ~ dunif(0,10)
),
start = list(a=1, sigma = 5), data = d1 )
compare(m1a, m1int)
library(tidyverse)
library(lubridate)
esc <- read.csv("data_tidy/escapement.csv", stringsAsFactors = FALSE, header = TRUE)
str(esc)
esc$detyear <- as.numeric(esc$detyear)
esc$chn <- ifelse(esc$species == "chn", 1, 0)
esc <- as.data.frame(esc)
m <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a + bchn*chn ,
a ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc)
m2 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a ,
a ~ dnorm(0, 10)
),
data = esc)
compare(m, m2)
precis(m)
exp(-2.65)
head(esc)
esc <- read.csv("data_tidy/escapement.csv", stringsAsFactors = FALSE, header = TRUE)
str(esc)
tail(esc)
precis(m)
precis(m, prob = 0.95)
exp(-2.65)
exp(-2.65)*100 # a salmon's odds of escapement were
1.84*100
post <- extract.samples(m)
p.escape.salmon <- logistic(post$a + post$bchn)
p.escape.wst <- logistic(post$a)
diff.esc <- p.escape.salmon - p.escape.wst
quantile(diff.esc, c(0, 0.025, 0.5, 0.975))  # means that the median estimate of escapement for salmon is about -23%, with a 95% CI of between -40% and -14%.
quantile(diff.esc, c(0.025, 0.5, 0.975))  # means that the median estimate of escapement disadvantage for salmon is about -34%, with a 95% CI of between -52% and -14%.
dens(diff.esc)
plot(post)
plot(postcheck)
postcheck(m)
str(esc)
esc$year_id <- coerce_index(esc$detyear)
esc
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 10)
),
data = esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 1)
),
data = esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 10)
),
data = esc, start = list(a=5))
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 15)
),
data = esc, start = list(a=1))
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 15)
),
data = esc, start = list(a[detyear]=1))
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 20)
),
data = esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear],
a[detyear] ~ dnorm(0, 30)
),
data = esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc)
esc
esc$chn <- ifelse(esc$species == "chn", 1, 0)
esc <- as.data.frame(esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc)
detach("package:tidyverse", unload=TRUE)
detach("package:rethinking", unload=TRUE)
library(rethinking)
head(esc)
esc$chn <- ifelse(esc$species == "chn", 1, 0)
esc <- as.data.frame(esc)
esc
m <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a + bchn*chn ,
a ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc)
m2 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a ,
a ~ dnorm(0, 10)
),
data = esc)
compare(m, m2)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 1),
bchn ~ dnorm(0, 10)
),
data = esc)
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 30),
bchn ~ dnorm(0, 10)
),
data = esc, start = list(a=10))
m3 <- map(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 30),
bchn ~ dnorm(0, 10)
),
data = esc, start = list(a=10, bchn = 3))
m3 <- map2stan(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear] + bchn*chn,
a[detyear] ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc, start = list(a=1),
chains = 2, warmup = 500, iter = 1e4)
esc$detyear_id <- coerce_index(esc$detyear)
m3 <- map2stan(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear_id] + bchn*chn,
a[detyear_id] ~ dnorm(0, 10),
bchn ~ dnorm(0, 10)
),
data = esc, start = list(a=1),
chains = 2, warmup = 500, iter = 1e4)
range(esc$escaped)
m3 <- map2stan(
alist(
escaped ~ dbinom(sample_size, p) ,
logit(p) <- a[detyear_id] + bchn*chn,
a[detyear_id] ~ dnorm(3, 20),
bchn ~ dnorm(3, 10)
),
data = esc, start = list(a=3),
chains = 2, warmup = 500, iter = 1e4)
str(esc)
precis(m2, prob = 0.95)
logistic(1.47)
library(tidyverse)
library(ybp)
library(fishtrackr)
library(lubridate)
library(viridis)
library(beepr)
d <- all69khz_grouped
d2 <- d %>%
arrange(DateTimeUTC) %>%
mutate(detyear =
ifelse(
DateTimeUTC > "2011-07-01 00:00:00" & DateTimeUTC < "2012-06-30 00:00:00", "2011",
ifelse(
DateTimeUTC > "2012-07-01 00:00:00" & DateTimeUTC < "2013-06-30 00:00:00", "2012",
ifelse(
DateTimeUTC > "2013-07-01 00:00:00" & .$DateTimeUTC < "2014-06-30 00:00:00", "2013",
ifelse(
DateTimeUTC > "2014-07-01 00:00:00" & DateTimeUTC < "2015-06-30 00:00:00", "2014", "2015"
)
) )
d2 <- d2 %>%
group_by(TagID) %>%
filter(DateTimeUTC >= DateTagged) %>%
arrange(DateTimeUTC)
maxrkms <- d2 %>%
group_by(detyear, TagID) %>%
mutate(maxrkm = max(Rkm)) %>%
ungroup()
head(maxrkms)
maxrkms$detyear <- factor(maxrkms$detyear, labels = c(  "2011 - 2012",
"2012 - 2013",
"2013 - 2014",
"2014 - 2015",
"2015 - 2016"))
maxrkms <- filter(maxrkms, detyear != "2011 - 2012")
maxsum <- maxrkms %>%
group_by(detyear, Sp, TagID) %>%
filter(!duplicated(TagID)) %>%
summarise(maxrkm_reached = maxrkm)
head(maxsum)
detach("package:tidyverse", unload=TRUE)
detach("package:dplyr", unload=TRUE)
library(rethinking)
detach("package:purrr", unload = TRUE)
library(rethinking)
install.packages(c("ggplot2", "lubridate", "rstan", "StanHeaders"))
library(rethinking)
detach("package:tidyverse", unload=TRUE)
detach("package:dplyr", unload=TRUE)
detach("package:purrr", unload = TRUE)
library(rethinking)
head(maxsum)
d1 <- maxsum
d1$dSp <- ifelse(d1$Sp == "chn", 1, 0)
d1 <- as.data.frame(d1)
head(d1)
range(maxsum$maxrkm_reached)
detach("package:rethinking", unload = TRUE)
library(tidyverse)
detach("package:stats", unload=TRUE)
library("stats", lib.loc="/Library/Frameworks/R.framework/Versions/3.3/Resources/library")
detach("package:StanHeaders", unload=TRUE)
detach("package:rstan", unload=TRUE)
load(file = "data_tidy/fishpaths11-15.Rdata")
head(d3)
d3$residence <- d3$departure - d3$arrival
units(d3$residence) = "days"
library(dplyr)
res <- d3 %>%
group_by(detyear, TagID, Sp) %>%
summarise(firstarrival = min(arrival), lastdeparture = max(departure)) %>%
mutate(totalres = lastdeparture - firstarrival)
units(res$totalres) <- "days"
res$totalres <- as.numeric(res$totalres)
res <- filter(res, TagID != 13728) # mortality
res$detyear <- factor(res$detyear, labels = c(  "2011 - 2012",
"2012 - 2013",
"2013 - 2014",
"2014 - 2015",
"2015 - 2016"))
res <- filter(res, detyear != "2011 - 2012")
head(res)
res %>%
group_by(detyear, Sp) %>%
summarise(meanres = mean(totalres))
res %>%
group_by(detyear, Sp) %>%
summarise(meanres = mean(totalres), sdres = sd(totalres))
restab <- res %>%
group_by(detyear, Sp) %>%
summarise(meanres = mean(totalres), sdres = sd(totalres))
write.csv(restab, file = "data_tidy/restab.csv")
f <- d3
comps <- f %>%  # run the model on this one
group_by(Sp, detyear) %>%
mutate(nfish = len(TagID)) %>%
filter(!duplicated(detyear)) %>%
select(detyear, Sp, nfish)
comps
library(tidyverse)
library(ybp)
library(fishtrackr)
library(lubridate)
library(viridis)
f <- d3
comps <- f %>%  # run the model on this one
group_by(Sp, detyear) %>%
mutate(nfish = len(TagID)) %>%
filter(!duplicated(detyear)) %>%
select(detyear, Sp, nfish)
comps
d <- all69khz_grouped
d2 <- d %>%
arrange(DateTimeUTC) %>%
mutate(detyear =
ifelse(
DateTimeUTC > "2011-07-01 00:00:00" & DateTimeUTC < "2012-06-30 00:00:00", "2011",
ifelse(
DateTimeUTC > "2012-07-01 00:00:00" & DateTimeUTC < "2013-06-30 00:00:00", "2012",
ifelse(
DateTimeUTC > "2013-07-01 00:00:00" & .$DateTimeUTC < "2014-06-30 00:00:00", "2013",
ifelse(
DateTimeUTC > "2014-07-01 00:00:00" & DateTimeUTC < "2015-06-30 00:00:00", "2014", "2015"
)
) )
d2 <- d2 %>%
group_by(TagID) %>%
filter(DateTimeUTC >= DateTagged) %>%
arrange(DateTimeUTC)
maxrkms <- d2 %>%
group_by(detyear, TagID) %>%
mutate(maxrkm = max(Rkm)) %>%
ungroup()
head(maxrkms)
maxrkms$detyear <- factor(maxrkms$detyear, labels = c(  "2011 - 2012",
"2012 - 2013",
"2013 - 2014",
"2014 - 2015",
"2015 - 2016"))
maxrkms <- filter(maxrkms, detyear != "2011 - 2012")
maxsum <- maxrkms %>%
group_by(detyear, Sp, TagID) %>%
filter(!duplicated(TagID)) %>%
summarise(maxrkm_reached = maxrkm)
head(maxsum)
?t.test
ggplot(maxsum, aes(x = maxrkm_reached)) + geom_density(aes(color = Sp))
ggplot(maxsum, aes(x = maxrkm_reached)) + geom_density(aes(color = Sp)) + facet_wrap(~detyear)
x = filter(maxsum)
restab
res <- d3 %>%
group_by(detyear, TagID, Sp) %>%
summarise(firstarrival = min(arrival), lastdeparture = max(departure)) %>%
mutate(totalres = lastdeparture - firstarrival)
units(res$totalres) <- "days"
res$totalres <- as.numeric(res$totalres)
res <- filter(res, TagID != 13728) # mortality
res$detyear <- factor(res$detyear, labels = c(  "2011 - 2012",
"2012 - 2013",
"2013 - 2014",
"2014 - 2015",
"2015 - 2016"))
restab <- res %>%
group_by(detyear, Sp) %>%
summarise(meanres = mean(totalres), sdres = sd(totalres))
restab
comps <- f %>%  # run the model on this one
group_by(Sp, detyear) %>%
mutate(nfish = len(TagID)) %>%
filter(!duplicated(detyear)) %>%
select(detyear, Sp, nfish)
comps
